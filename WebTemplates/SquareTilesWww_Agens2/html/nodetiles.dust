<div class="text-center" id="isotope_content_row">
    <div class="filter-box">
        <!--
        <div class="isotope-sort categories">
            <a href="#" class="isotope-sort-filter filter button" data-filter-value=".ROOTCATEGORY"><i class="icon-home"></i></a>
            {#RootCategories}
                <a href="#"  class="isotope-sort-filter filter button"
                   data-categoryid="{ID}" data-filter-value=".cat{ID}">{Title}</a>
            {/RootCategories}
        </div>
        -->
    </div>
    <div id="tilecontainer">
        {#Nodes}
            <div class=""><!-- three_col four_col two_col -->
                {#CollectionContent}
                    <div data-title="{Title}" class="nodetile {?Categories}{#Categories}cat{ID} {CategoryName} {/Categories}{:else}ROOTCATEGORY{/Categories} ">
                        {?ImageBaseUrl}
                            <div class="tileimagecontainer">
                                {?IsCategoryFilteringNode}
                                    <a class="hover filter" href="#" data-filter-value=".cat{OriginalContentID}" data-categoryid="{OriginalContentID}">
                                        <img class="tileimage" src="{ImageBaseUrl}_320x240_crop{ImageExt}" alt="" /><span class="plus"></span>
                                    </a>
                                {:else}
                                    {@eq key=TechnicalSource value="LINKTOCONTENT"}
                                        <a class="hover" href="{ActualContentUrl}">
                                            <img class="tileimage" src="{ImageBaseUrl}_320x240_crop{ImageExt}" alt="" /><span class="plus"></span>
                                        </a>
                                    {:else}
                                        {@eq key=TechnicalSource value="IMAGE"}
                                            <img class="tileimage" src="{ImageBaseUrl}_320x240_crop{ImageExt}" alt="" /><span class="plus"></span>
                                        {:else}
                                            <a class="hover oipclicktoview" href="#" data-original-content-id="{OriginalContentID}">
                                                <img class="tileimage" src="{ImageBaseUrl}_320x240_crop{ImageExt}" alt="" /><span class="plus"></span>
                                            </a>
                                        {/eq}
                                    {/eq}
                                {/IsCategoryFilteringNode}
                            </div>
                        {:else}
                            {@eq key=TechnicalSource value="EMBEDDEDCONTENT"}
                                <a style="max-height: 150px" href="#" class="oipclicktoview" data-original-content-id="{OriginalContentID}">
                                    <iframe style="width: 100%;height: 100%" {ActualContentUrl|s}></iframe>
                                </a>
                            {/eq}
                        {/ImageBaseUrl}
                        <div class="entry-summary">
                            <h4>
                                {?IsCategoryFilteringNode}
                                    <a class="filter button filter" href="#"
                                       data-filter-value=".cat{OriginalContentID}" data-categoryid="{OriginalContentID}">{Title}</a>
                                {:else}
                                    {@eq key=TechnicalSource value="LINKTOCONTENT"}
                                        <a href="{ActualContentUrl}">{Title}</a>
                                    {:else}
                                        {@eq key=TechnicalSource value="IMAGE"}
                                            <div>{Title}</div>
                                        {:else}
                                            <a class="oipclicktoview stylelink" href="#" data-original-content-id="{OriginalContentID}">{Title}</a>
                                        {/eq}
                                    {/eq}
                                {/IsCategoryFilteringNode}
                            </h4>
                            <div class="excerpt">{ExcerptRendered|s}</div>
                            {?IsCategoryFilteringNode}
                            {:else}
                                <a class="pricetag oipclicktoview button" href="#" data-original-content-id="{OriginalContentID}">{#Authors}{#CollectionContent}{Content}{/CollectionContent}{/Authors}</a>
                            {/IsCategoryFilteringNode}
                        </div>
                    </div>
                {/CollectionContent}
            </div>
        {/Nodes}
    </div>

</div>
<script>

    var applyIndexStyleClasses = function() {
        var $nodetiles = $(".nodetile").not(".isotope-hidden").sort(function(elem1, elem2) {
            var $e1 = $(elem1);
            var $e2 = $(elem2);
            var pos1 = $e1.data("isotope-item-position");
            var pos2 = $e2.data("isotope-item-position");
            var val1 = pos1.x;
            var val2 = pos2.x;
            if(val1 == val2)
                return 0;
            return val1 < val2 ? -1 : 1;
        }).sort(function(elem1, elem2) {
            var $e1 = $(elem1);
            var $e2 = $(elem2);
            var pos1 = $e1.data("isotope-item-position");
            var pos2 = $e2.data("isotope-item-position");
            var val1 = pos1.y;
            var val2 = pos2.y;
            if(val1 == val2)
                return 0;
            return val1 < val2 ? -1 : 1;
        });
        console.log("Styling total tiles: " + $nodetiles.length);

        var currIX = 0;
        $nodetiles.each(function(ix, elem) {
            var $elem = $(elem);
            /*var position = $elem.data("isotope-item-position");
            var xIndex = parseInt(position.x / $elem.width());
            var yIndex = parseInt(position.y / $elem.height());
            var posIX = xIndex + yIndex;
            console.log("X: " + xIndex + " Y: " + yIndex + " Posix: " + posIX);
            currIX = posIX % 4;*/
            console.log("CurrIX: " + currIX);
            var className = "styleix" + currIX;
            $elem.addClass(className);
            currIX = (currIX + 1) % 4;
        });
    };

    $(function(){
        var $container = $('#tilecontainer');
        var filters = {};

        $container.isotope({
            itemSelector : '.nodetile',
            filter: '.ROOTCATEGORY',
            itemPositionDataEnabled: true,
            getSortData: {
                rankFunc: function($item) {
                    var title = $item.data("title");
                    if(!CurrentCategoryID)
                        return title;
                    var rankObjects = CategoryContentMap[CurrentCategoryID];
                    var myIndex = _.findIndex(rankObjects, function(rItem) {
                        return rItem.Title == title;
                    });
                    return myIndex;
                }
            }
        });

        var loaded = 0;
        var numImages = $("img").length;
        $("img").load(function() {
            ++loaded;
            if (loaded === numImages) {
                $container.isotope('reLayout');
            }
        });

        applyIndexStyleClasses();

        /* filter buttons */
        $('a.filter').click(function(){
            var $this = $(this);
            var categoryID = $this.data("categoryid");
            CurrentCategoryID = categoryID;
            /* don't proceed if already selected */
            if ( $this.hasClass('selected') ) {
                console.log("Already selected, skipping...");
                return false;
            }
            /*
            alert("FILTERING!");
            */
            var $optionSet = $this.parents('.isotope-sort');
            /* change selected class */
            $optionSet.find('.selected').removeClass('selected');
            $(".contentfilter-selected").removeClass("selected").removeClass(".contentfilter-selected");
            $this.addClass('selected');
            $this.addClass("contentfilter-selected");

            var filterValue = $this.attr("data-filter-value");
            console.log("Applying filter selector: " + filterValue);
            $container.isotope({ filter: filterValue });
            if(CurrentCategoryID) {
                $container.isotope('updateSortData', $(".nodetile"));
                $container.isotope({ sortBy: "rankFunc" });
                updateMainLogo(CurrentCategoryID);
            } else {
                $container.isotope({ sortBy: "original-order"});
            }
            applyIndexStyleClasses();
            return false;
        });

        if(navigator.appName != 'Microsoft Internet Explorer')
        {
            $container.imagesLoaded( function() {
                $container.isotope({
                    filter : '.ROOTCATEGORY'
                });
            });
        }

    });

    $(function() {
        $("#TileDefaultFilter").trigger('click');

        var getOIParticleUrl = function (type, id) {
            var prefix;
            var suffix = "_DefaultView.phtml";
            switch (type) {
                case "textcontent":
                    return "../../AaltoGlobalImpact.OIP/TextContent/" + id + ".json";
                case "news":
                    prefix = "AaltoGlobalImpact.OIP.Blog_";
                    break;
                case "activity":
                    prefix = "AaltoGlobalImpact.OIP.Activity_";
                    break;
            }
            return prefix + id + suffix;
        };

        var getURLParameter = function (name) {
            return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
        };
        var typePar = getURLParameter("type");
        var idPar = getURLParameter("id");
        if (typePar != null && idPar != null) {
            var oipArticleUrl = getOIParticleUrl(typePar, idPar);
            OipOpenArticle(oipArticleUrl);
            window.history.pushState("string", "Schools The Ball", "index.html");
        }
    });

</script>

