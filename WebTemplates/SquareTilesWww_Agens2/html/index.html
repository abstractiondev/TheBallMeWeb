<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Agens - Sopien</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Agens - Sopien">
    <meta name="author" content="Agens">

    <link rel="stylesheet" href="../assets/css/foundation.css" />
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" type="text/css" media="all" href="../assets/css/whhg.css" />
    <link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet">
    <!-- Le styles -->

    <link href="../assets/css/leaflet.css" rel="stylesheet"/>
    <!-- get a fresh copy live at 	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />-->
    <link rel="stylesheet" href="../assets/css/MarkerCluster.Default.css" />
    <!--[if lte IE 8]>
    <link href="../assets/css/leaflet.css" rel="stylesheet"/>
    <link href="../assets/css/MarkerCluster.Default.ie.css" rel="stylesheet" />
    <![endif]-->

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6/html5shiv.min.js"></script>
    <![endif]-->

    <!-- other javascript -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="../assets/js/oipdynamicreplacer.js"></script>
    <!-- or get a fresh copy at <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>-->
    <!-- get a fresh live version from <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>-->
    <script src="../assets/js/leaflet.js"></script>
    <script src="../assets/js/leaflet.markercluster.js"></script>
    <!--[if lt IE 9]>
    <script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
    <![endif]-->

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-70307324-1', 'auto');
        ga('send', 'pageview');

    </script>
</head>

<body data-spy="scroll" data-target=".subnav" data-offset="50">
<script src="../assets/js/dust-core-1.2.3.min.js"></script>
<script src="../assets/js/dust-helpers-1.1.1.js"></script>
<script src="../assets/js/jquery.isotope.js" type="text/javascript"></script>
<script src="nodetiles_dust.js"></script>
<script src="textcontent_detailpane_dust.js"></script>
<script src="../assets/js/rgbcolor.js"></script>

<script src="../assets/js/foundation.min.js"></script>
<script src="../assets/js/foundation/foundation.topbar.js"></script>
<script src="../assets/js/jquery.isotope.js" type="text/javascript"></script>
<script src="../assets/js/jquery.form.min.js"></script>
<script src="../assets/js/jquery.htmlClean.min.js "></script>
<script src="../assets/lib/markdowndeep/MarkdownDeepLib.min.js"></script>
<script src="../assets/js/purl.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
<script src="../assets/oiplib1.0/TheBall.Interface.UI/TemplateModuleManager.js"></script>
<script src="../assets/oiplib1.0/TheBall.Interface.UI/DataConnectionManager.js"></script>
<script src="../assets/oiplib1.0/TheBall.Interface.UI/OperationManager.js"></script>
<script src="../assets/oiplib1.0/TheBall.Interface.UI/UpdatingDataGetter.js"></script>
<script src="../assets/js/index.js"></script>

<style>

    a.oipclicktoview > iframe {
        pointer-events: none;
    }

    a.goldlink {
        color: #cc983c;
        font-weight: bolder;
    }

    a.goldlink:hover {
        color: #ebc500;
        font-weight: bolder;
    }

    .button.filter {
        font-size: large;
        padding:7px;
        margin:2px;
        border-radius: 3px;
    }

    iframe, object, embed {
        max-width: 100%;
        max-height: 100%;
        /*height: 100%;*/
    }

    .fullWidth {
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        max-width: 100% !important;
    }

    .video-modal {
        height: 99% !important;
        width: 95% !important;
        top: 2px !important;
        margin-top: auto;
    }

    .reveal-modal {
        padding: 0;
        background: white;
        border: 0px;
        -webkit-box-shadow: none;
        box-shadow: none;
    }

    .reveal-modal-inner {
        max-height: 100%;
        margin: 0 auto;
        position: relative;
        -webkit-box-shadow: 0 0 10px rgba(0,0,0,0.4);
        box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    .boxshadow {
        -webkit-box-shadow: 10px 10px 10px 0px rgba(205,205,205,0.5);
        -moz-box-shadow: 10px 10px 10px 0px rgba(205,205,205,0.5);
        box-shadow: 10px 10px 10px 0px rgba(205,205,205,0.5);
    }

    .logomedium
    {
        margin: 10px;
        width: 320px;
        background-color: white;
        border-color: gold;
        border-style: solid;
        border-width: 1px;
    }

    .logosmall
    {
        margin: 10px;
        width: 220px;
        background-color: white;
        border-color: gold;
        border-style: solid;
        border-width: 1px;
    }

    .logolargeup
    {
        margin: 10px;
        height: 50%;
        /*width: 320px;*/
        background-color: white;
        border-color: gold;
        border-style: solid;
        border-width: 1px;
    }

    .logolargeuprow
    {
        height: 100%;
    }

    .logomediumrow
    {
        height: 50%;
    }
    .logosmallrow
    {
        height: 50%;
    }
</style>

<div class="row text-center show-for-large-up logolargeuprow">
    <div id="logocontainer-large" class="logolargeup boxshadow">
    </div>
</div>
<div class="row text-center show-for-medium-only logomediumrow">
    <div id="logocontainer-medium" class="logomedium boxshadow">
    </div>
</div>
<div class="row text-center show-for-small-only logosmallrow">
    <div id="logocontainer-small" class="logosmall boxshadow">
    </div>
</div>

<!-- start reading-pane -->
<div id="SelectedContentContainer" class="container reading-pane">
</div>
<!-- end reading-pane -->

<div class="container masonry" id="TileSection">
    <img src="../assets/img/ajax-loader.gif">
</div>
<script type="text/javascript">

    var ensureModalClose = function() {
        var $modal = $("#viewContentModal");
        if($modal)
        {
            $modal.foundation('reveal', 'close');
        }
    };

    window.onpopstate = function(event) {
        ensureModalClose();
    };

    $(function() {
        OipCloseDetailPane = function() {
            $("#SelectedContentContainer").html('');
        };
        $(".oipmenuselector").on("click", function() {
            var filterName = $(this).data("filtername");
            var navigateto = $(this).data("locateto");
            //alert(navigateto);
            //var scrollPos = $(navigateto).offset().top;
            //$(document).animate({ scrollTop : $(navigateto).offset().top}, 'slow');
            //$(document).scrollTop($(navigateto).offset().top);
            OipCloseDetailPane();
            $("a[data-filter='" + filterName + "']").trigger('click');
            $('[data-toggle="dropdown"]').parent().removeClass('open');
            return true;
        });

        OipShowHtmlInDetailPaneWithClose = function(htmlContent) {
            $("#SelectedContentContainer").html('<button id="paneclosebutton" type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>' +
                    htmlContent + '</div>' + '</div>' );
            $("#paneclosebutton").off("click");
            $("#paneclosebutton").click(OipCloseDetailPane);
        };
        OipShowTextContentInDetailPaneWithClose = function(textContentObject) {
            dust.render("textcontent_detailpane.dust", textContentObject, function (err, out) {
                $("#SelectedContentContainer").html('<button id="paneclosebutton" type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>' +
                        out + '</div>' + '</div>' );
                $("#paneclosebutton").off("click");
                $("#paneclosebutton").click(OipCloseDetailPane);
            });
        };


        dust.helpers.iFrameLines = function (chunk, context, bodies, params) {
            var value = context.current()[params.contextField];
            var valueList = value.split("\n");
            var writeValue = "";
            for(var i = 0; i < valueList.length; i++)
            {
                writeValue += "<iframe " + valueList[i] + "></iframe>";
            }
            return chunk.write(writeValue);
        };

    });

    var CurrNodeSummary;
    var CurrLocations;
    var CurrGroupContainer;

    var getCategoriesOrderedAndFiltered = function(categoryCollection)
    {
        var categories = categoryCollection.CollectionContent;
        var orderFilterIDList = categoryCollection.OrderFilterIDList;
        var orderedCategories = [];
        for(i = 0; i < orderFilterIDList.length; i++)
        {
            var currID = orderFilterIDList[i];
            var result = $.grep(categories, function(candidate) { return candidate.ID == currID });
            if(result.length == 0)
                continue;
            var cat = result[0];
            orderedCategories.push(cat);
        }
        return orderedCategories;
    };

    var getRootCategories = function(categoryCollection)
    {
        var orderedCategories = getCategoriesOrderedAndFiltered(categoryCollection);
        var rootCategories = $.grep(orderedCategories, function(candidate) { return !candidate.ParentCategoryID; });
        return rootCategories;
    };
    var getCategoriesBasedByNamesOrIDs = function(categoryCollection, nameShortTextCollection, categoryIDList)
    {
        var orderedCategories = getCategoriesOrderedAndFiltered(categoryCollection);
        var filteredCategories;
        var alreadyInList = {};
        if(categoryIDList)
        {
            var categoryIDArray = categoryIDList.split(",");
            filteredCategories = $.grep(orderedCategories,
                    function(candidate) {
                        var foundList = $.grep(categoryIDArray, function(idCandidate) {
                            return idCandidate === candidate.ID;
                        });
                        if(foundList.length > 0 && !alreadyInList[candidate.ID]) {
                            alreadyInList[candidate.ID] = true;
                            return true;
                        }
                        return false;
                    });
        } else {
            filteredCategories = $.grep(orderedCategories,
                    function(candidate) {
                        var foundList = $.grep(nameShortTextCollection.CollectionContent, function(nameCandidate) {
                            return nameCandidate.Content == candidate.CategoryName;
                        });
                        if(foundList.length > 0 && !alreadyInList[candidate.CategoryName]) {
                            alreadyInList[candidate.CategoryName] = true;
                            return true;
                        }
                        return false;
                    });
        }
        filteredCategories = filteredCategories.sort(function(a,b) {
            return a.CategoryName.localeCompare(b.CategoryName);
        });
        return filteredCategories;
    }

    var calcBrightness = function (color) {
        return Math.sqrt(
                color.r * color.r * .299 +
                        color.g * color.g * .587 +
                        color.b * color.b * .114);
    }

    var blackOrWhiteTextColorOnBGColor = function(bgColor)
    {
        var rgbColor = new RGBColor(bgColor);
        var brightness = calcBrightness(rgbColor);
        if(brightness < 130)
            return "#FFFFFF";
        return "#000000";
    };

    var stringToColour = function(str) {
        // str to hash
        for (var i = 0, hash = 0; i < str.length; hash = str.charCodeAt(i++) + ((hash << 5) - hash));
        // int/hash to hex
        for (var i = 0, colour = "#"; i < 3; colour += ("00" + ((hash >> i++ * 8) & 0xFF).toString(16)).slice(-2));
        return colour;
    }


    $(function () {
        var fetchDatas = [
            "../../AaltoGlobalImpact.OIP/NodeSummaryContainer/default.json",
            "../../AaltoGlobalImpact.OIP/AddressAndLocationCollection/MasterCollection.json",
            "../../AaltoGlobalImpact.OIP/GroupContainer/default.json"
        ];
        $.each(fetchDatas, function(index, value) {
            fetchDatas[index] = $.ajax({ url: value, cache:true });
        });
        /*$.get("../../AaltoGlobalImpact.OIP/NodeSummaryContainer/default.json", function ()jsonObject) {*/
        $.when.apply($, fetchDatas).then(function() {

            var nodeSummary = arguments[0][0];
            CurrNodeSummary = nodeSummary;
            CurrCategories = nodeSummary.NodeSourceCategories.CollectionContent;
            CurrLocations = arguments[1][0];
            CurrGroupContainer = arguments[2][0];

            var imageData = CurrGroupContainer.GroupProfile.ProfileImage.ImageData;
            updateLogoFromImageData(imageData);

            var myObj = nodeSummary;
            nodeSummary.RootCategories = getRootCategories(nodeSummary.NodeSourceCategories);
            for(var nodeIX = 0; nodeIX < myObj.Nodes.CollectionContent.length; nodeIX++)
            {
                var nodeObj = myObj.Nodes.CollectionContent[nodeIX];
                nodeObj.Categories = getCategoriesBasedByNamesOrIDs(nodeSummary.NodeSourceCategories, nodeObj.CategoryNames, nodeObj.CategoryIDList);
                ReplaceWithMarkdownRender(nodeObj, "Excerpt", "ExcerptRendered");
            }
            var base = dust.makeBase(
                    {
                        catTagColor: function(chunk, context) { return chunk.write(stringToColour(context.get("CategoryName")));},
                        catFilterTagColor: function(chunk, context) { return chunk.write(stringToColour(context.get("Content")));},
                        catTagTextColor: function(chunk, context) {
                            var bgColor = stringToColour(context.get("CategoryName"));
                            var textColor = blackOrWhiteTextColorOnBGColor(bgColor);
                            chunk.write(textColor);
                        },
                        catFilterTagTextColor: function(chunk, context) {
                            var bgColor = stringToColour(context.get("Content"));
                            var textColor = blackOrWhiteTextColorOnBGColor(bgColor);
                            chunk.write(textColor);
                        },
                        catName: function(chunk, context) {
                            context.get("CategoryName");
                        }
                    });
            dust.render("nodetiles.dust", base.push(myObj), function (err, out) {
                $("#TileSection").html(out);
            });
        });
    });

    var updateLogoFromImageData = function(imageData)
    {
        var $logoLarge = $("#logocontainer-large");
        var $logoMedium = $("#logocontainer-medium");
        var $logoSmall = $("#logocontainer-small");
        if(imageData != null)
        {
            $logoLarge.html("<img style='height:100%;' src='../../AaltoGlobalImpact.OIP/MediaContent/" + imageData.ID + imageData.FileExt + "' />");
            $logoMedium.html("<img style='height:100%;' src='../../AaltoGlobalImpact.OIP/MediaContent/" + imageData.ID + imageData.FileExt + "' />");
            $logoSmall.html("<img src='../../AaltoGlobalImpact.OIP/MediaContent/" + imageData.ID + imageData.FileExt + "' />");
        } else {
            $logoLarge.html("");
            $logoMedium.html("");
            $logoSmall.html("");
        }
    };

    var findCategory = function(categoryID)
    {
        var matchingCats = $.grep(CurrCategories, function(cat) {
            return cat.ID == categoryID;
        });
        if(matchingCats.length >= 1)
            return matchingCats[0];
        return null;
    };

    var updateMainLogo = function(categoryID)
    {
        console.log("Updating logo with: " + categoryID);
        var category = findCategory(categoryID);
        var imageData = category != null ? category.ImageData : null;
        updateLogoFromImageData(imageData);
    };
</script>

<!--<div class="container clearfix">-->
<!--<section class="well">-->
<!--&lt;!&ndash; '../oip-containers/oip-container-contact-oip.txt' &ndash;&gt;&lt;!&ndash; UseInformationObjectAsRoot:AaltoGlobalImpact.OIP.ContactOipContainer  &ndash;&gt;-->
<!--</section>-->
<!--</div>-->
<footer class="footer" style="background-color:white;">
    <div class="container">
        <div class="span12" style="text-align: center;font-weight: 200;margin-bottom: 20px; margin-top: 40px;color:black">
            <!--<p class="pull-right"><a href="#">Back to top</a></p>-->
            <p style="text-align: center;font-style: oblique;font-size: 24px;font-family: Georgia" id="PoweredBy">Agens - Sopien</p>
            <div style="text-align: center; color: lightseagreen"><a href="" style="color: lightseagreen"></a></div>
        </div>
    </div>
</footer>
<!-- end oip-modal-collection.txt -->
<!-- ========== End: www-public\..\oip-containers\../oip-modals/oip-modal-collection.txt ========== -->

<div id="ModalsHolderDiv-Content">
    <div id="viewContentModal" class="reveal-modal xlarge" data-reveal>
        <!--Begins contents of  div for the viewContentModal-->
        <div class="row fullWidth">
            <div class="show-for-large-up large-2 columns" id="categorypanel">
            </div>
            <div class="large-8 columns">
                <div class="row">
                    <div class="large-12 columns" style="width:100%;padding-bottom: 12px;padding-right:10px;padding-top:10px;"><strong><span id="viewContentModal-title" class="hugeTitleText"></span></strong>
                    </div>
                </div>
                <div class="row show-for-large-up">
                    <div class="large-12 columns" style="padding-right:15px;"><span  id="viewContentModal-excerpt" class="contentCardExcerpt bigTitleText discreetTextColor"></span></div>
                </div>
            </div>
            <div class="large-2 columns show-for-large-up"><img src="../assets/img/Agens-small-rez320.png">
                <!--
                <div class="row">
                    <div class="large-12 columns">
                        <label class="discreetTextColor">Share:</label>
                        <input type="text" placeholder="" id="articleShareURLinput"/>
                    </div>
                </div>
                -->
            </div>
        </div>
        <div class="row fullWidth">
            <div class="large-12 columns" style="padding-right:0;padding-top: 0;padding-bottom:0;"><div class="content-card-line"><hr></div></div>
        </div>
        <div class="row">
            <div class="large-12 columns" style="height:20px;"></div>
        </div>
        <div class="row">
            <div class="large-12 columns articleText" id="viewContentModal-content" style="padding-left: 15px !important; padding-right: 15px !important;"></div>
        </div>
        <div class="row">
            <div id="viewContentModal-attachments"></div>
        </div>
        <div class="row">
            <div id="viewContentModal-iframes"></div>
        </div>
        <!--
        <div class="row">
            <div class="large-12 columns">
                <br>
                <label class="discreetTextColor">Share:</label>
                <input type="text" placeholder="" id="articleShareURLinput"/>
            </div>
        </div>
        -->
        <div class="row">
            <div class="large-12">
                <br>
                <a class="button" id="closeViewContentModal" style="float:right !important;">Close</a>
            </div>
        </div>
        <a class="close-reveal-modal">&#215;</a>
    </div> <!--closes div for the viewContentModal-->
</div>



</body>

</html>

