<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>iZENZEi Online Taekwondo Training</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="iZENZEi Online Taekwondo Training">
    <meta name="author" content="Various Authors">

    <link rel="stylesheet" href="../assets/css/foundation.css" />
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" type="text/css" media="all" href="../assets/css/whhg.css" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet">
    <script src="../assets/js/modernizr.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="../assets/js/oipdynamicreplacer.js"></script>

    <!-- other javascript -->

</head>

<body data-spy="scroll" data-target=".subnav" data-offset="50">
<script src="../assets/js/dust-core-1.2.3.min.js"></script>
<script src="../assets/js/dust-helpers-1.1.1.js"></script>
<script src="nodetiles_dust.js"></script>
<script src="textcontent_detailpane_dust.js"></script>
<script src="../assets/js/rgbcolor.js"></script>

<script src="../assets/js/foundation.min.js"></script>
<!--<script src="js/foundation/foundation.js"></script>-->
<script src="../assets/js/foundation/foundation.topbar.js"></script>
<script src="../assets/js/jquery.isotope.js" type="text/javascript"></script>
<script src="../assets/js/jquery.form.min.js"></script>
<script src="../assets/js/jquery.htmlClean.min.js "></script>
<script src="../assets/lib/markdowndeep/MarkdownDeepLib.min.js"></script>
<script src="../assets/js/purl.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
<script src="../assets/oiplib1.0/TheBall.Interface.UI/TemplateModuleManager.js"></script>
<script src="../assets/oiplib1.0/TheBall.Interface.UI/DataConnectionManager.js"></script>
<script src="../assets/oiplib1.0/TheBall.Interface.UI/OperationManager.js"></script>
<script src="../assets/oiplib1.0/TheBall.Interface.UI/UpdatingDataGetter.js"></script>
<script src="../assets/js/index.js"></script>

<style>
    iframe, object, embed {
        max-width: 100%;
        max-height: 100%;
    }

    .fullWidth {
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        max-width: initial;
    }

    .video-modal {
        height: 99% !important;
        width: 95% !important;
        top: 2px !important;
        margin-top: auto;
    }

    .reveal-modal {
        padding: 0;
        background: white;
        border: 0px;
        -webkit-box-shadow: none;
        box-shadow: none;
    }

    .reveal-modal-inner {
        max-height: 100%;
        margin: 0 auto;
        position: relative;
        -webkit-box-shadow: 0 0 10px rgba(0,0,0,0.4);
        box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
</style>

<div class="row text-center">
    <div id="logocontainer" style="background-color: white; margin: 10px; border-color: gold;border-style: solid;border-width: 1px" class="logo-only">
    </div>
</div>


<!-- start reading-pane -->
<div id="SelectedContentContainer" class="container reading-pane">
</div>
<!-- end reading-pane -->

<div class="container masonry" id="TileSection">
    <img src="../assets/img/ajax-loader.gif">
</div>
<script type="text/javascript">

    $(function() {
        OipCloseDetailPane = function() {
            $("#SelectedContentContainer").html('');
        };
        $(".oipmenuselector").on("click", function() {
            var filterName = $(this).data("filtername");
            var navigateto = $(this).data("locateto");
            //alert(navigateto);
            //var scrollPos = $(navigateto).offset().top;
            //$(document).animate({ scrollTop : $(navigateto).offset().top}, 'slow');
            //$(document).scrollTop($(navigateto).offset().top);
            OipCloseDetailPane();
            $("a[data-filter='" + filterName + "']").trigger('click');
            $('[data-toggle="dropdown"]').parent().removeClass('open');
            return true;
        });

        OipShowHtmlInDetailPaneWithClose = function(htmlContent) {
            $("#SelectedContentContainer").html('<button id="paneclosebutton" type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>' +
                    htmlContent + '</div>' + '</div>' );
            $("#paneclosebutton").off("click");
            $("#paneclosebutton").click(OipCloseDetailPane);
        };
        OipShowTextContentInDetailPaneWithClose = function(textContentObject) {
            dust.render("textcontent_detailpane.dust", textContentObject, function (err, out) {
                $("#SelectedContentContainer").html('<button id="paneclosebutton" type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>' +
                        out + '</div>' + '</div>' );
                $("#paneclosebutton").off("click");
                $("#paneclosebutton").click(OipCloseDetailPane);
            });
        };


        dust.helpers.iFrameLines = function (chunk, context, bodies, params) {
            var value = context.current()[params.contextField];
            var valueList = value.split("\n");
            var writeValue = "";
            for(var i = 0; i < valueList.length; i++)
            {
                writeValue += "<iframe " + valueList[i] + "></iframe>";
            }
            return chunk.write(writeValue);
        };

    });

    var CurrNodeSummary;
    var CurrLocations;
    var CurrGroupContainer;

    var getCategoriesOrderedAndFiltered = function(categoryCollection)
    {
        var categories = categoryCollection.CollectionContent;
        var orderFilterIDList = categoryCollection.OrderFilterIDList;
        var orderedCategories = [];
        for(i = 0; i < orderFilterIDList.length; i++)
        {
            var currID = orderFilterIDList[i];
            var result = $.grep(categories, function(candidate) { return candidate.ID == currID });
            if(result.length == 0)
                continue;
            var cat = result[0];
            orderedCategories.push(cat);
        }
        return orderedCategories;
    };

    var getRootCategories = function(categoryCollection)
    {
        var orderedCategories = getCategoriesOrderedAndFiltered(categoryCollection);
        var rootCategories = $.grep(orderedCategories, function(candidate) { return !candidate.ParentCategoryID; });
        return rootCategories;
    };
    var getCategoriesBasedByNamesOrIDs = function(categoryCollection, nameShortTextCollection, categoryIDList)
    {
        var orderedCategories = getCategoriesOrderedAndFiltered(categoryCollection);
        var filteredCategories;
        var alreadyInList = {};
        if(categoryIDList)
        {
            var categoryIDArray = categoryIDList.split(",");
            filteredCategories = $.grep(orderedCategories,
                    function(candidate) {
                        var foundList = $.grep(categoryIDArray, function(idCandidate) {
                            return idCandidate === candidate.ID;
                        });
                        if(foundList.length > 0 && !alreadyInList[candidate.ID]) {
                            alreadyInList[candidate.ID] = true;
                            return true;
                        }
                        return false;
                    });
        } else {
            filteredCategories = $.grep(orderedCategories,
                    function(candidate) {
                        var foundList = $.grep(nameShortTextCollection.CollectionContent, function(nameCandidate) {
                            return nameCandidate.Content == candidate.CategoryName;
                        });
                        if(foundList.length > 0 && !alreadyInList[candidate.CategoryName]) {
                            alreadyInList[candidate.CategoryName] = true;
                            return true;
                        }
                        return false;
                    });
        }
        filteredCategories = filteredCategories.sort(function(a,b) {
            return a.CategoryName.localeCompare(b.CategoryName);
        });
        return filteredCategories;
    }

    var calcBrightness = function (color) {
        return Math.sqrt(
                color.r * color.r * .299 +
                        color.g * color.g * .587 +
                        color.b * color.b * .114);
    }

    var blackOrWhiteTextColorOnBGColor = function(bgColor)
    {
        var rgbColor = new RGBColor(bgColor);
        var brightness = calcBrightness(rgbColor);
        if(brightness < 130)
            return "#FFFFFF";
        return "#000000";
    };

    var stringToColour = function(str) {
        // str to hash
        for (var i = 0, hash = 0; i < str.length; hash = str.charCodeAt(i++) + ((hash << 5) - hash));
        // int/hash to hex
        for (var i = 0, colour = "#"; i < 3; colour += ("00" + ((hash >> i++ * 8) & 0xFF).toString(16)).slice(-2));
        return colour;
    }


    $(function () {
        var fetchDatas = [
            "../../AaltoGlobalImpact.OIP/NodeSummaryContainer/default.json",
            "../../AaltoGlobalImpact.OIP/AddressAndLocationCollection/MasterCollection.json",
            "../../AaltoGlobalImpact.OIP/GroupContainer/default.json"
        ];
        $.each(fetchDatas, function(index, value) {
            fetchDatas[index] = $.ajax({ url: value, cache:false });
        });
        /*$.get("../../AaltoGlobalImpact.OIP/NodeSummaryContainer/default.json", function ()jsonObject) {*/
        $.when.apply($, fetchDatas).then(function() {

            var nodeSummary = arguments[0][0];
            CurrNodeSummary = nodeSummary;
            CurrLocations = arguments[1][0];
            CurrGroupContainer = arguments[2][0];

            var imageData = CurrGroupContainer.GroupProfile.ProfileImage.ImageData;
            if(imageData != null)
            {
                $("#logocontainer").html("<img height='20%' src='../../AaltoGlobalImpact.OIP/MediaContent/" + imageData.ID + imageData.FileExt + "' />");
            }

            var myObj = nodeSummary;
            nodeSummary.RootCategories = getRootCategories(nodeSummary.NodeSourceCategories);
            for(var nodeIX = 0; nodeIX < myObj.Nodes.CollectionContent.length; nodeIX++)
            {
                var nodeObj = myObj.Nodes.CollectionContent[nodeIX];
                console.log("Node: " + nodeObj.Title + " " + nodeObj.CategoryIDList);
                nodeObj.Categories = getCategoriesBasedByNamesOrIDs(nodeSummary.NodeSourceCategories, nodeObj.CategoryNames, nodeObj.CategoryIDList);
                ReplaceWithMarkdownRender(nodeObj, "Excerpt", "ExcerptRendered");
            }
            var base = dust.makeBase(
                    {
                        catTagColor: function(chunk, context) { return chunk.write(stringToColour(context.get("CategoryName")));},
                        catFilterTagColor: function(chunk, context) { return chunk.write(stringToColour(context.get("Content")));},
                        catTagTextColor: function(chunk, context) {
                            var bgColor = stringToColour(context.get("CategoryName"));
                            var textColor = blackOrWhiteTextColorOnBGColor(bgColor);
                            chunk.write(textColor);
                        },
                        catFilterTagTextColor: function(chunk, context) {
                            var bgColor = stringToColour(context.get("Content"));
                            var textColor = blackOrWhiteTextColorOnBGColor(bgColor);
                            chunk.write(textColor);
                        },
                        catName: function(chunk, context) {
                            context.get("CategoryName");
                        }
                    });
            dust.render("nodetiles.dust", base.push(myObj), function (err, out) {
                $("#TileSection").html(out);
            });
        });
    });
</script>

<footer class="footer" style="background-color:white;">
    <div class="container">
        <div class="span12" style="text-align: center;font-weight: 200;margin-bottom: 20px;color:black">
            <!--<p class="pull-right"><a href="#">Back to top</a></p>-->
            <p style="text-align: center;font-style: oblique;font-size: 24px;font-family: Georgia">Your partner in online training</p>
            <div style="text-align: center; color: lightseagreen"><a href="" style="color: lightseagreen"></a></div>
        </div>
    </div>
</footer>

<div id="ModalsHolderDiv-Content">
    <div id="viewContentModal" class="reveal-modal xlarge video-modal" data-reveal>
        <!--Begins contents of  div for the viewContentModal-->
        <div class="row fullWidth">
            <div class="large-2 columns" id="viewContentModal-image"></div>
            <div class="large-8 columns">
                <div class="row">
                    <div class="large-12 columns" style="width:100%;padding-bottom: 12px;padding-right:10px;padding-top:10px;"><strong><span id="viewContentModal-title" class="hugeTitleText"></span></strong>
                    </div>
                </div>
                <div class="row">
                    <div class="large-12 columns" style="padding-right:15px;"><span  id="viewContentModal-excerpt" class="contentCardExcerpt bigTitleText discreetTextColor"></span></div>
                </div>
            </div>
            <div class="large-2 columns"><img src="../assets/img/izenzei-logo.jpg"></div>
        </div>
        <div class="row fullWidth">
            <div class="large-12 columns" style="padding-right:0;padding-top: 0;padding-bottom:0;"><div class="content-card-line"><hr></div></div>
        </div>
        <div class="row fullWidth">
            <div class="large-12 columns articleText" id="viewContentModal-content" style="padding-left: 15px !important; padding-right: 15px !important;"></div>
        </div>
        <div class="row">
            <div id="viewContentModal-attachments"></div>
        </div>
        <div class="row">
            <div id="viewContentModal-iframes"></div>
        </div>
        <div class="row">
            <div class="large-12 columns">
                <br>
                <label class="discreetTextColor">Share:</label>
                <input type="text" placeholder="" id="articleShareURLinput"/>
            </div>
        </div>
        <div class="row">
            <div class="large-12">
                <br>
                <a class="button" id="closeViewContentModal" style="float:right !important;">Close</a>
            </div>
        </div>
        <a class="close-reveal-modal">&#215;</a>
    </div> <!--closes div for the viewContentModal-->
</div>



</body>

<script type="text/javascript">

    var clearViewContentOnClose = function() {
        $("#viewContentModal-content").html("");
        $("#viewContentModal-iframes").html("");
    };

    $(".close-reveal-modal").on("click", function() {

    });

    $("#closeViewContentModal").on("click", function() {
        $("#viewContentModal").foundation("reveal", "close");
    });

    String.prototype.replaceAll = function(strReplace, strWith) {
        var reg = new RegExp(strReplace, 'ig');
        return this.replace(reg, strWith);
    };

    var ReplaceWithMarkdownRender = function(containingObj, sourceField, targetField)
    {
        var markdown = new MarkdownDeep.Markdown();
        markdown.SafeMode = true;
        if(containingObj == false)
            return;
        var sourceData = containingObj[sourceField];
        var renderedData;
        if(sourceData)
            renderedData = markdown.Transform(sourceData.replaceAll("javascript:", ""));
        else
            renderedData = "";
        containingObj[targetField] = renderedData;
    };

    OipOpenArticle = function(urlarg, addRelativePath) {
        var targeturl = $(this).data('contenturl');
        if (targeturl == null) {
            targeturl = urlarg;
            if(addRelativePath)
                targeturl = "../" + targeturl;
        }
        else
            targeturl = "../" + targeturl;
        if (targeturl == null) {
            return;
        }
        $.ajax({
            url: targeturl,
            cache: true,
            success: function (textContent) {
                var articleUrl = targeturl;
                var currentID = textContent.ID;
                var iFrameList = [];
                if(textContent.IFrameSources) {
                    var nonTaggedList = textContent.IFrameSources.split('\n');
                    $.each(nonTaggedList, function(index, value) {
                        var taggedVersion = "<iframe " + value + "></iframe>";
                        iFrameList.push(taggedVersion);
                    });
                }
                var contentData = { "CollectionContent": [ textContent ] };
                var queryValue="";
                markdown = new MarkdownDeep.Markdown();
                markdown.SafeMode = true;
                var i = 0;

                queryValue=contentData.CollectionContent[i].Title;
                $("#viewContentModal-title").empty();
                $('#viewContentModal-title').append(queryValue);

                queryValue="<p>"+contentData.CollectionContent[i].Excerpt+"</p>";
                $("#viewContentModal-excerpt").empty();
                $('#viewContentModal-excerpt').append(queryValue);

                //var currentMainCategory=contentData.CollectionContent[i].Categories.CollectionContent[0].Title;
                var currentMainCategory="News";

                //queryValue=contentData.CollectionContent[i].content_type;
                $("#viewContentModal-categories").empty();
                $('#viewContentModal-categories').append(currentMainCategory);

                var rawbody;
                rawbody = contentData.CollectionContent[i].RawHtmlContent;
                if(rawbody) {
                    rawbody=rawbody.replace(new RegExp("div", "g"), 'p');
                    rawbody=rawbody.replace(new RegExp("<span>", "g"), '');
                    rawbody=rawbody.replace(new RegExp("</span>", "g"), '');

                    queryValue=$.htmlClean(rawbody, {
                        removeTags: ["basefont", "center", "dir", "font", "frame", "frameset", "isindex", "menu", "noframes", "s", "strike", "u"],
                        format:true
                    });
                } else {
                    var bodyRendered = markdown.Transform(contentData.CollectionContent[i].Body.replaceAll("javascript:", ""));
                    rawbody = bodyRendered;
                    queryValue = rawbody;
                }

                $("#viewContentModal-content").empty();
                $('#viewContentModal-content').append(queryValue);

                var lastSlashIndex = articleUrl.lastIndexOf("/");
                var lastExtIndex = articleUrl.lastIndexOf(".json");
                var articleIDFromArticleUrl = articleUrl.substring(lastSlashIndex + 1, lastExtIndex);
                var currentURL = "http://www.onlinetaekwondo.com/html/index.html?type=text&id="+ articleIDFromArticleUrl;
                $("#articleShareURLinput").attr("placeholder",currentURL);
                $("#articleShareURLinput").val(currentURL);

                if ((contentData.CollectionContent[i].Author===null)||(!contentData.CollectionContent[i].Author) )
                    var currentAuthor="Aalto Global Impact";
                else
                    var currentAuthor=contentData.CollectionContent[i].Author;
                queryValue=contentData.CollectionContent[i].Author;
                $("#viewContentModal-Author").empty();
                $('#viewContentModal-Author').append(currentAuthor);

                var recordedJsonDate = contentData.CollectionContent[i].Published;
                var pattern = /[0-9]+/; //to find the number within the string, first occurrence.
                recordedJsonDate = (recordedJsonDate.match(pattern))/1000;
                var extractedDate= new Date(1000*recordedJsonDate);
                //extractedDate = extractedDate.toLocaleString();
                var cardDate = extractedDate.getDate()+".";
                cardDate+= (extractedDate.getMonth() + 1) +".";
                cardDate+= extractedDate.getFullYear();

                $("#viewContentModal-Date").empty();
                $('#viewContentModal-Date').append(cardDate );

                //send the correspondent image to the placeholder, but clean its containing div first
                if (contentData.CollectionContent[i].ImageData===null)
                {
                    var currentImage= "images/preview.jpg";
                }

                else
                {
                    var imgID = contentData.CollectionContent[i].ImageData.ID;
                    var imgExtension = contentData.CollectionContent[i].ImageData.AdditionalFormatFileExt;
                    var currentImage= "../../AaltoGlobalImpact.OIP/MediaContent/"+imgID+"_320x240_crop"+imgExtension;
                }
                $("#viewContentModal-image").empty(); //clean the image Placeholder in the form
                queryValue = "<img src='"+currentImage+"' style='width:auto;height:auto;max-width:350;max-height:450px;margin-left:auto;margin-right:auto;'>";
                $("#viewContentModal-image").append(queryValue);


                $("#viewContentModal-iframes").empty();
                $.each(iFrameList, function(index, value) {
                    $("#viewContentModal-iframes").append(value);
                });

                $("#viewContentModal-attachments").empty();

                //var myAttachments = getObjectAttachments(currentID);
                var myAttachments = [];
                if(myAttachments.length > 0) {
                    var myBinaries = [];
                    for(var attachmentIX = 0; attachmentIX < myAttachments.length; attachmentIX++)
                    {
                        var currAttachment = myAttachments[attachmentIX];
                        var binaryFileID = currAttachment.SourceObjectID;
                        var attachedBinary = getBinaryFile(binaryFileID);
                        if(attachedBinary && attachedBinary.Data)
                            myBinaries.push(attachedBinary);
                    }
                    myBinaries.sort(function(a, b) {
                        if(a && b && a.OriginalFileName && b.OriginalFileName)
                            return a.OriginalFileName.localeCompare(b.OriginalFileName);
                        return 0;
                    });
                    for(var binaryIX = 0; binaryIX < myBinaries.length; binaryIX++)
                    {
                        var currBinary = myBinaries[binaryIX];
                        var data = currBinary.Data;
                        var contentID = data.ID;
                        var originalFileName = currBinary.OriginalFileName;
                        var binaryUrl = encodeURI("../../AaltoGlobalImpact.OIP/MediaContent/" + contentID + "/" + originalFileName);
                        var binaryLinkTag = '<br><a href="' + binaryUrl +  '">' + originalFileName + '</a><br>';
                        $("#viewContentModal-attachments").append(binaryLinkTag);
                    }

                }

                $('#viewContentModal').foundation('reveal', 'open');

            }
        });
        return;
    };
    $(function() {
        /*$(".oipclicktoview").on('click', OipOpenArticle);*/
        $(document).on("click", ".oipclicktoview", OipOpenArticle);
    });

    $(document).foundation(
            {
                reveal : {
                    animation: 'fadeAndPop',
                    animation_speed: 250,
                    close_on_background_click: false
                }

            }
    );

    var openArticle = function (articleType, articleID) {
        var articleUrl;
        if(articleType == "text")
            articleUrl = "../../AaltoGlobalImpact.OIP/TextContent/" + articleID + ".json";
        OipOpenArticle(articleUrl);
    }


    $(function () {
        var openArticleType = $.url().param("type");
        var openArticleID = $.url().param("id");
        if(openArticleType && openArticleID) {
            window.history.pushState("string", "Aalto Global Impact", "index.html");
            openArticle(openArticleType, openArticleID);
        }
    });

</script>



</html>

