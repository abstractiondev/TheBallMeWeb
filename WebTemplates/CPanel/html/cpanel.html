<html>
<head>
    <title></title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Control Panel | Welcome</title>
    <link rel="stylesheet" href="../assets/controlpanel/css/foundation.orange.css"/>
    <link rel="stylesheet" href="../assets/controlpanel/css/style.orange.css">
    <link rel="stylesheet" href="../assets/controlpanel/css/jquery-te-1.4.0.css">
    <link rel="stylesheet" type="text/css" media="all" href="../assets/controlpanel/css/whhg.css"/>
    <link rel="stylesheet" href="../assets/controlpanel/css/redactor.css"/>

    <script src="../assets/controlpanel/js/modernizr.js"></script>
    <script src="../assets/controlpanel/js/jquery.js"></script>
    <script src="../assets/controlpanel/js/oipdynamicreplacer.js"></script>
    <script src="../assets/controlpanel/js/oipuieventhelpers.js"></script>

    <script src="../assets/controlpanel/js/foundation.min.js"></script>
    <script src="../assets/controlpanel/js/jquery.isotope.js" type="text/javascript"></script>
    <script src="../assets/controlpanel/js/jquery.form.min.js"></script>
    <script src="../assets/controlpanel/js/redactor.min.js"></script>
    <script src="../assets/controlpanel/js/jquery.htmlClean.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/dustjs-linkedin/2.0.0/dust-core.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/dustjs-helpers/1.2.0/dust-helpers.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script src="../assets/controlpanel/modules/lib/jquery-nestable/jquery.nestable.js"></script>
    <link rel="stylesheet" href="../assets/controlpanel/modules/lib/jquery-nestable/jquery-nestable.css"/>

    <script src="../assets/controlpanel/js/markdowndeep/MarkdownDeepLib.min.js"></script>
    <script src="../assets/oiplib1.0/TheBall.Interface.UI/TemplateModuleManager.js"></script>
    <script src="../assets/oiplib1.0/TheBall.Interface.UI/DataConnectionManager.js"></script>
    <script src="../assets/oiplib1.0/TheBall.Interface.UI/OperationManager.js"></script>
    <script src="../assets/oiplib1.0/TheBall.Interface.UI/UpdatingDataGetter.js"></script>
    <script src="../assets/controlpanel/modules/ModuleCustomGlue.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.66.0-2013.10.09/jquery.blockUI.min.js"></script>
    <script type="text/javascript" src="//s3.amazonaws.com/cdn.knightlab.com/libs/timeline/latest/js/storyjs-embed.js"></script>
    <!--
    <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="go5l70wh2a6b59n"></script>
    -->

    <style>
        .oip-dropdown-button {
            padding: 14px !important;
            color: white !important; margin: 2px;
        }
        iframe, object, embed {
            max-width: 100%;
            max-height: 100%;
        }

        .fullWidth {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }

    </style>

    <script>
        var wnd = window;
        if (!wnd.ControllerCommon) {
            wnd.ControllerCommon = { };
        }
        wnd.ControllerCommon.ModalButtonClick = function (event) {
            var $owningModal = $(this).closest(".oip-controller-modal");
            var controller = $owningModal.data("oip-controller-instance");
            controller.handleModalEvent($owningModal, $(this), "click", event);
        };

        wnd.DisplayErrorDialog = function(errorCaptionText, errorTypeText, errorMessageText, callbackAfterError) {
            var $errorModal = $("#CommonErrorModal");
            var $errorCaption = $("#CommonErrorLabel");
            var $errorType = $("#CommonErrorType");
            var $errorMessage = $("#CommonErrorMessage");
            $errorCaption.empty();
            $errorCaption.html(errorCaptionText);
            $errorType.empty();
            $errorType.html(errorTypeText);
            $errorMessage.empty();
            $errorMessage.html(errorMessageText);
            //$errorModal.foundation("reveal", "open");
            var $errorOKButton = $("#CommonErrorOKButton");
            $errorOKButton.off("click").on("click", function() {
                $.unblockUI();
                /*
                if(callbackAfterError)
                    setTimeout(callbackAfterError, 1000);*/
                return false;
            });
            $.blockUI({ message: $errorModal, onUnblock:callbackAfterError });
        };

    </script>
    <script data-main="../assets/controlpanel/modules/config" type="text/javascript"
            src="../assets/controlpanel/modules/require.js"></script>
</head>
<body>

<div class="off-canvas-wrap" data-offcanvas>
<div class="inner-wrap">
<nav class="tab-bar">
    <section class="left-small"><a class="left-off-canvas-toggle menu-icon"><span></span></a></section>
    <section class="middle tab-bar-section"><h1 id="NavbarTitle" class="title">The Ball - Open Innovation Platform - Group Loading...</h1></section>
</nav>
<aside class="left-off-canvas-menu">
    <ul class="off-canvas-list">
        <li><label>Manage Posts</label></li>
        <li><a href="#" id="addEditContentMenuAnchor" class="offCanvasMenuAnchor">Add or Edit Posts</a></li>
        <li><a href="#" id="manageCategoriesMenuAnchor" class="offCanvasMenuAnchor">Add or Edit Categories</a></li>
        <li><a href="#" id="fileManagerMenuAnchor" class="offCanvasMenuAnchor">File Manager</a></li>
        <li><a href="#" id="connectionsMenuAnchor" class="offCanvasMenuAnchor">Connections to Other Groups</a></li>
        <!--
        <li><a href="#" id="timelineMenuAnchor" class="offCanvasMenuAnchor">View data as timeline</a></li>
        -->
        <li><label>Manage Pages</label></li>
        <li><a href="#" id="dynamicContentMenuAnchor" class="offCanvasMenuAnchor">Dynamic Page Content</a></li>

        <li><label>General Options</label></li>
        <li><a href="#" id="groupInfoMenuAnchor" class="offCanvasMenuAnchor">Group</a></li>
        <li><a href="#" id="groupMembersMenuAnchor" class="offCanvasMenuAnchor">Group Members</a></li>
        <li><a href="/auth/account/cpanel/html/account.html">My Personal Account</a></li>
        <li><a href="../../categoriesandcontent/html/group.html">Old Group UI</a></li>
        <li><a href="/TheBallLogin.aspx?SignOut=true">Logout</a></li>
    </ul>
</aside>

<section class="main-section">
<div class="row" id="canvasMainSectionRow">
<div class="large-12 columns contentSwitchableSection activeSection" id="addEditContentSection">
    <p>Loading Content...</p>
</div>

<div class="large-12 columns contentSwitchableSection" id="categoriesSection">
    <p>Loading Categories...</p>
</div>

<div class="large-12 columns contentSwitchableSection" id="fileManagerSection">
    <h3>Loading Files...</h3>
</div>

<div class="large-12 columns contentSwitchableSection" id="connectionsSection">
    <h3>Loading Connections...</h3>
</div>

<div class="large-12 columns contentSwitchableSection" id="groupSection">
    <h3>Loading Group Data...</h3>
</div>

<div class="large-12 columns contentSwitchableSection" id="groupMembersSection">
    <h3>Loading Group Members...</h3>
</div>

<div class="large-12 columns contentSwitchableSection" id="dynamicContentSection">
    <h3>Loading Dynamic Content Editor...</h3>
</div>

<!--
<div class="large-12 columns contentSwitchableSection" id="timelineSection">
    <div class="row"><div class="small-12 medium-12 large-12 columns"><h4 class="boldieText">Timeline</h4></div></div>
    <div class="row"><div class="small-12 medium-12 large-12 columns"><div id="my-timeline"></div></div></div>
</div>
-->

</div>
<!--Closes the Main Section Div, where the content (switchable) goes-->
</section>
<a class="exit-off-canvas"></a>
</div>
</div>

<div id="CommonErrorModal" style="display:none; cursor: default">
    <h3 id="CommonErrorLabel"></h3>
    <div class="row">
        <div class="large-12 columns"><label id="CommonErrorType"></label>
            <h4 id="CommonErrorMessage"></h4>
        </div>
    </div>
    <div class="row" style="margin-top: 20px;">
        <div class="large-12 columns"><button id="CommonErrorOKButton">OK</button>
        </div>
    </div>
</div>


<!-- Footer -->
<!-- End Footer -->

<script>


    var parseRawTimestampToDate = function (value) {
        var timestamp;
        if (!value)
            timestamp = new Date();
        else {
            timestamp = new Date(value);
            if (isNaN(timestamp))
                timestamp = new Date(parseInt(value.substr(6)));
        }
        return timestamp;
    };

    var ParseRawTimestampToSortableNumber = function(value) {
        var timeStamp = parseRawTimestampToDate(value);
        return timeStamp.getTime();
    };

    var ParseRawTimestampToDateString = function (value) {
        //return timestamp.toISOString();
        var timestamp = parseRawTimestampToDate(value);
        return timestamp.getDate() + "." + (timestamp.getMonth() + 1) + "." + timestamp.getFullYear();
    };

    var ParseRawTimestampToDateTimeString = function (value) {
        var timestamp = parseRawTimestampToDate(value);
        var day = timestamp.getDate();
        var month = timestamp.getMonth() + 1;
        var year = timestamp.getFullYear();
        var hours = timestamp.getHours();
        var minutes = timestamp.getMinutes();
        var seconds = timestamp.getSeconds();
        return day + "." + month + "." + year
                + " " + hours + ":" + (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);
    };

    var ParseRawTimestampToISOString = function (value) {
        var timestamp = parseRawTimestampToDate(value);
        return timestamp.toISOString();
    }


    var tUI = TheBall.Interface.UI;
    var tDCM = new tUI.DataConnectionManager();
    var tOP = new tUI.OperationManager(tDCM);
    var tUDG = new tUI.UpdatingDataGetter();

    tUDG.RegisterDataURL("SEMANTICCONTENT", function(args) {
        var textContentCollection = args[0][0];
        var linkToContentCollection = args[1][0];
        var embeddedContentCollection = args[2][0];
        var categoryCollection = args[3][0];
        var sourceUnion = _.union(textContentCollection.CollectionContent,
                linkToContentCollection.CollectionContent,
                embeddedContentCollection.CollectionContent,
                categoryCollection.CollectionContent);
        var semanticCollection = _.map(sourceUnion, function(item) {
            var semanticObject = {
                "ContentID": item.ID,
                "SemanticDomain": item.SemanticDomainName,
                "SemanticType": item.Name,
                "Title": item.Title
                //"Object": item
            };
            if(semanticObject.SemanticDomain == "AaltoGlobalImpact.OIP" && semanticObject.SemanticType == "Category")
            {
                semanticObject.CategoryIDs = [];
                if(item.ParentCategoryID != null)
                    semanticObject.CategoryIDs.push(item.ParentCategoryID);
            }
            else {
                if(item.Categories != null)
                {
                    semanticObject.CategoryIDs =
                            _.map(item.Categories.CollectionContent, function(catItem) { return catItem.ID; })
                } else {
                    semanticObject.CategoryIDs = [];
                }

            }
            return semanticObject;
        });
        return semanticCollection;
    }, [ "../../AaltoGlobalImpact.OIP/TextContentCollection/MasterCollection.json",
        "../../AaltoGlobalImpact.OIP/LinkToContentCollection/MasterCollection.json",
        "../../AaltoGlobalImpact.OIP/EmbeddedContentCollection/MasterCollection.json",
        "../../AaltoGlobalImpact.OIP/CategoryCollection/MasterCollection.json",
    ]);

    tUDG.RegisterDataURL("CATEGORYTREE", function (args) {
        var nodeSummaryContainer = args[0][0];
        var categoriesWithChildren = AppScripts.Common.ConvertCategoriesFromParentToChildren(nodeSummaryContainer.NodeSourceCategories.CollectionContent);
        var categoryListWithTitleIndented = AppScripts.Common.GetCategoryListWithTitleIndentation(categoriesWithChildren);
        var contentCategoryRanks = args[1][0];
        console.log(JSON.stringify(contentCategoryRanks));
        var semanticContents = args[2];
        var manualRanks = _.where(contentCategoryRanks.CollectionContent, { "RankName": "MANUAL" } );
        console.log("Unfiltered: " + contentCategoryRanks.CollectionContent);
        console.log(JSON.stringify(manualRanks));
        manualRanks = _.sortBy(manualRanks, function(item) {
            return item.RankValue;
        });
        var categoryManualRankMap = _.groupBy(manualRanks, function(item) {
            return item.CategoryID;
        });


        var semanticContentCategoryMap = {};
        _.forEach(semanticContents, function(semItem) {
            _.forEach(semItem.CategoryIDs, function(catID) {
                var currentMapArray = semanticContentCategoryMap[catID];
                if(!currentMapArray) {
                    currentMapArray = [];
                    semanticContentCategoryMap[catID] = currentMapArray;
                }
                var containsAlready = _.any(currentMapArray, function(item) {
                    return item.ContentID == semItem.ContentID;
                });
                if(!containsAlready) {
                    semItem.RankValue = "200000";
                    currentMapArray.push(semItem);
                }
            });
        });

        // Sort semantic contents based on category rank map
        _.each(semanticContentCategoryMap, function(arrayData, key) {
            var rankData = categoryManualRankMap[key];
            if(rankData) {
                var sortedArray = _.sortBy(arrayData, function(item) {
                    var rankIndex = _.findIndex(rankData, function(ixCandidate) {
                        return ixCandidate.ContentID == item.ContentID;
                    });
                    if(rankIndex == -1)
                        return item.RankValue;
                    item.RankValue = rankData[rankIndex].RankValue;
                    return rankIndex;
                });
                semanticContentCategoryMap[key] = sortedArray;
            }
        });

        return {
            CategoriesWithChildren: categoriesWithChildren,
            CategoryList : categoryListWithTitleIndented,
            ManualRankingMap : categoryManualRankMap,
            SemanticContentMap : semanticContentCategoryMap
        };
    }, [
        "../../AaltoGlobalImpact.OIP/NodeSummaryContainer/default.json",
        "../../AaltoGlobalImpact.OIP/ContentCategoryRankCollection/MasterCollection.json",
        "SEMANTICCONTENT"
    ]);

    tUDG.RegisterDataURL("../../AaltoGlobalImpact.OIP/GroupContainer/default.json", function (args) {
    });

    tUDG.RegisterDataURL("../../AaltoGlobalImpact.OIP/DynamicContentCollection/MasterCollection.json", function(args) {
    });

    tUDG.RegisterDataURL("DYNAMICVIEWCONTENT", function(args) {
        var dynamicContentCollection = args[0][0];
        var dynamicContentGroupCollection = args[1][0];
        dynamicContentCollection.CollectionContent.sort(function(a, b) {
            if(a.HostName == b.HostName)
                return 0;
            if(!a.HostName)
                return -1;
            var firstCompare = a.HostName.localeCompare(b.HostName);
            if(firstCompare)
                return firstCompare;
            if(a.ContentName == b.ContentName)
                return 0;
            if(!a.ContentName)
                return -1;
            return a.ContentName.localeCompare(b.ContentName);
        });
        dynamicContentGroupCollection.CollectionContent =
                _.sortBy(dynamicContentGroupCollection.CollectionContent, function(item) {
                    return item.SortValue;
                });

        // get templates
        var templateMap = _.groupBy(dynamicContentGroupCollection.CollectionContent, function(item) {
            return item.HostName;
        });
        var templateKeys = _.keys(templateMap);
        var templateArray = $.map(templateKeys, function(key) {
            var mapArray = templateMap[key];
            mapArray = _.sortBy(mapArray, function(item) {
                return item.SortValue;
            });
            return { "Host": key, "Templates": mapArray};
        });
        var templates = {
            Keys: templateKeys,
            MapData: templateMap,
            Array: templateArray
        };

        var itemMap = _.groupBy(dynamicContentCollection.CollectionContent, function(item) {
            return item.HostName;
        });
        var itemKeys = _.keys(itemMap);
        var itemArray = $.map(itemKeys, function(key) {
            return itemMap[key];
        });

        var templateItems = {
            Keys: itemKeys,
            MapData: itemMap,
            Array: itemArray
        };

        $.each(templates.Array, function(index, hostElement) {
            $.each(hostElement.Templates, function(index, element) {
                element.Key = element.HostName;
                var sourceItems = templateItems.MapData[element.Key];
                var itemNames = element.ContentItemNames.split(",");
                element.Items = $.map(itemNames, function(name) {
                    return _.find(sourceItems, function(srcItem) {
                        return srcItem.ContentName == name;
                    });
                });
            });
        });


        return {
            "DynamicContents": dynamicContentCollection,
            "DynamicContentGroups": dynamicContentGroupCollection,
            "Templates": templates,
            "TemplateItems": templateItems
        };
    }, [
                "../../AaltoGlobalImpact.OIP/DynamicContentCollection/MasterCollection.json",
                "../../AaltoGlobalImpact.OIP/DynamicContentGroupCollection/MasterCollection.json"
    ]);

    tUDG.RegisterDataURL("MAINCONTENT", function (args) {
        var textContentCollection = args[0][0];
        textContentCollection.CollectionContent.sort(function(a, b) {
            if(a.Published == b.Published)
                return 0;
            // Bigger comes first (latest first)
            if(a.Published < b.Published)
                return 1;
            return -1;
        });
        var categoryTree = args[1];
        //var categoryCollection = args[1][0];
        var categoryCollection = {
            CollectionContent: categoryTree.CategoryList
        };
        var commentCollection = args[2][0];
        var binaryFileCollection = args[3][0];
        var linkToContentCollection = args[4][0];
        var embeddedContentCollection = args[5][0];
        var connectionCollection = args[6][0];
        var groupContainer = args[7][0];
        var attachmentCollection = args[8][0];
        return {
            TextContents: textContentCollection,
            Categories: categoryCollection,
            Comments: commentCollection,
            Attachments: attachmentCollection,
            BinaryFiles: binaryFileCollection,
            LinkToContents: linkToContentCollection,
            EmbeddedContents: embeddedContentCollection,
            Connections: connectionCollection,
            GroupContainer: groupContainer
        };
    }, [ "../../AaltoGlobalImpact.OIP/TextContentCollection/MasterCollection.json",
        //"../../AaltoGlobalImpact.OIP/CategoryCollection/MasterCollection.json",
        "CATEGORYTREE",
        "../../AaltoGlobalImpact.OIP/CommentCollection/MasterCollection.json",
        "../../AaltoGlobalImpact.OIP/BinaryFileCollection/MasterCollection.json",
        "../../AaltoGlobalImpact.OIP/LinkToContentCollection/MasterCollection.json",
        "../../AaltoGlobalImpact.OIP/EmbeddedContentCollection/MasterCollection.json",
        "../../TheBall.Interface/ConnectionCollection/MasterCollection.json",
        "../../AaltoGlobalImpact.OIP/GroupContainer/default.json",
        "../../AaltoGlobalImpact.OIP/AttachedToObjectCollection/MasterCollection.json"
    ]);

    tUDG.RegisterDataURL("FILEMANAGERCONTENT", function(args) {
        var binaryFileCollection = args[0][0];
        var imageCollection = args[1][0];
        var categoryCollection = args[2][0];
        return {
            BinaryFiles : binaryFileCollection,
            ImageFiles : imageCollection,
            Categories : categoryCollection
        };
    }, [  "../../AaltoGlobalImpact.OIP/BinaryFileCollection/MasterCollection.json",
        "../../AaltoGlobalImpact.OIP/ImageCollection/MasterCollection.json",
        "../../AaltoGlobalImpact.OIP/CategoryCollection/MasterCollection.json"
    ]);

    tUDG.RegisterDataURL("CONNECTIONCONTENT", function(args) {
        var connectionCollection = args[0][0];
        var authenticatedAsDeviceCollection = args[1][0];
        return {
            Connections : connectionCollection,
            AuthenticatedAsDevices : authenticatedAsDeviceCollection,
            //Categories : categoryCollection
        };
    }, [  "../../TheBall.Interface/ConnectionCollection/MasterCollection.json",
        "../../TheBall.CORE/AuthenticatedAsActiveDeviceCollection/MasterCollection.json"
    ]);


    require(["GroupInfoView/GroupInfoViewController"], function (vcClass) {
        var vc = new vcClass("groupSection", tOP, tUDG);
        vc.Initialize("../../AaltoGlobalImpact.OIP/GroupContainer/default.json");
        vc.VisibleTemplateRender();
    });
    require(["CategoryView/CategoryViewController"], function (vcClass) {
        var vc = new vcClass("categoriesSection", tOP, tUDG);
        vc.Initialize("CATEGORYTREE");
        vc.VisibleTemplateRender();
    });
    require(["GroupMemberView/GroupMemberViewController"], function (vcClass) {
        var vc = new vcClass("groupMembersSection", tOP, tUDG);
        vc.Initialize("../../AaltoGlobalImpact.OIP/GroupContainer/default.json");
        vc.VisibleTemplateRender();
    });
    require(["MainContentView/MainContentViewController"], function (vcClass) {
        var vc = new vcClass("addEditContentSection", tOP, tUDG);
        vc.Initialize("MAINCONTENT");
        vc.VisibleTemplateRender();
    });

    require(["FileManagerView/FileManagerViewController"], function(vcClass) {
        var vc = new vcClass("fileManagerSection", tOP, tUDG);
        vc.Initialize("FILEMANAGERCONTENT");
        vc.VisibleTemplateRender();
    });

    require(["ConnectionView/ConnectionViewController"], function(vcClass) {
        var vc = new vcClass("connectionsSection", tOP, tUDG);
        vc.Initialize("CONNECTIONCONTENT");
        vc.VisibleTemplateRender();
    });

    require(["DynamicContentView/DynamicContentViewController"], function(vcClass) {
        var vc = new vcClass("dynamicContentSection", tOP, tUDG);
        vc.Initialize("DYNAMICVIEWCONTENT");
        vc.VisibleTemplateRender();
    });


</script>

</body>
</html>